machine:
  node:
    version: 6.1.0

general:
  branches:
    only:
      - master
      - beta

dependencies:
  override:
    - npm install -g npm@latest
    - npm install -g @angular/cli@latest
    - npm install -g angular-cli-ghpages@v0.5.0
    - npm install
    - ng version
    - sudo apt-get install -y aptitude
    - sudo aptitude -y install imagemagick
    - sudo aptitude -y install libmagickcore-dev
    - sudo aptitude -y install libmagickwand-dev
test:
  override:
    - echo "skipped, do nothing."


deployment:
  #the following commands deploy to the beta.capsulecd.com domain.
  beta:
    branch: beta
    commands:
      #resize the images in place
#      - mv src/assets/images/bg src/assets/images/orig
      - mogrify -adaptive-resize 2000x1000> -quality 90 src/assets/images/bg/*

      - ng build --base-href "/" --dev
      - cp dist/angular.html dist/404.html
      - angular-cli-ghpages --message "Autodeploy to gh-pages" --no-silent --name "Jason Kulatunga" --email "jason@thesparktree.com"

  # the following command deploys to www.capsulecd.com domain if the change is made on the master branch.
  production:
    branch: master
    commands:
      - ls
      - pwd
      - ls /
      - ng build --prod --sourcemap --output-path ../dist --base-href "/"
      - cp ../dist/angular.html ../dist/404.html
      - echo "www.quietthyme.com" > ../dist/CNAME
      - cd ../dist && git init && git add . && git commit -m "Deploy"
      - cd ../dist && git remote add origin git@github.com:AnalogJ/quietthyme-web.git
      - cd ../dist && git push --force origin master:gh-pages